rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============ UTILITAIRES ============
    function isAuthenticated() {
      return request.auth != null;
    }

    function isAdmin() {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // ✅ Mode développement — à déclencher via doc settings/env
    function isDevMode() {
      return exists(/databases/$(database)/documents/settings/env)
        && get(/databases/$(database)/documents/settings/env).data.mode == 'dev';
    }

    function isNotBanned() {
      return isAuthenticated() &&
        (!exists(/databases/$(database)/documents/users/$(request.auth.uid)) ||
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isBanned != true);
    }

    function isDocOwner() {
      return isAuthenticated() && resource.data.uid == request.auth.uid;
    }

    function creatingOwnDoc() {
      return isAuthenticated() && request.resource.data.uid == request.auth.uid;
    }

    function isProviderRole() {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['lawyer', 'expat'];
    }

    function hasValidUserFields() {
      return request.resource.data.keys().hasAll(['email','role','firstName','lastName']) &&
        request.resource.data.email is string &&
        request.resource.data.role in ['client','lawyer','expat','admin'] &&
        request.resource.data.firstName is string &&
        request.resource.data.lastName is string;
    }

    function hasNoSensitiveChanges() {
      return !request.resource.data.diff(resource.data).affectedKeys()
        .hasAny(['role','isAdmin','isApproved','isBanned','uid','email','type','isVerified']);
    }

    function isPublicProfile() {
      return (resource.data.isVisible == true || resource.data.isVisibleOnMap == true) &&
             (resource.data.type in ['lawyer','expat']);
    }

    function changedKeys() {
      return request.resource.data.diff(resource.data).changedKeys();
    }

    function onlyPhotoFieldsChanged() {
      return changedKeys().hasOnly(['profilePhoto','photoURL','avatar','updatedAt']);
    }

    function emailSelfSynced() {
      return changedKeys().hasOnly(['email','emailLower','updatedAt']) &&
             request.resource.data.email == request.auth.token.email;
    }

    function presenceFields() {
      return [
        'isOnline','availability','lastStatusChange','lastSeen','lastSeenAt','lastActiveAt',
        'updatedAt','isVisible','isVisibleOnMap','ua'
      ];
    }

    function presenceOnlyUpdate() {
      return changedKeys().hasOnly(presenceFields());
    }

    function sosProfileUpdate() {
      let allowedFields = [
        'isOnline','availability','lastStatusChange','lastSeen','lastSeenAt','lastActiveAt','updatedAt',
        'isVisible','isVisibleOnMap','ua','profilePhoto','photoURL','avatar',
        'fullName','email','phone','phoneCountryCode','languages','country',
        'description','bio','specialties','helpTypes','yearsOfExperience',
        'interventionCountries','practiceCountries'
      ];
      return changedKeys().hasOnly(allowedFields);
    }

    // =============== USERS ===============
    match /users/{userId} {
      allow read: if (isAuthenticated() && request.auth.uid == userId) ||
                   isAdmin() ||
                   (resource.data.isApproved == true && resource.data.role in ['lawyer','expat']) ||
                   isDevMode();

      allow create: if (isAuthenticated() &&
                     request.auth.uid == userId &&
                     creatingOwnDoc() &&
                     hasValidUserFields()) || isDevMode();

      allow update: if (
                      isAuthenticated() && request.auth.uid == userId && isNotBanned() && (
                        presenceOnlyUpdate() ||
                        onlyPhotoFieldsChanged() ||
                        emailSelfSynced() ||
                        hasNoSensitiveChanges()
                      )
                    ) || isAdmin() || isDevMode();

      allow delete: if isAdmin() || isDevMode();
    }

    // ====================== SOS_PROFILES ======================
    match /sos_profiles/{profileId} {
      allow read: if true;

      allow create: if (isAuthenticated() && (
                      (request.resource.data.uid == request.auth.uid &&
                       request.resource.data.type in ['lawyer','expat']) ||
                      (profileId == request.auth.uid &&
                       request.resource.data.type in ['lawyer','expat']) ||
                      isAdmin()
                    )) || isDevMode();

      allow update: if (isAuthenticated() && (
                      (resource.data.uid == request.auth.uid && sosProfileUpdate()) ||
                      (profileId == request.auth.uid && sosProfileUpdate()) ||
                      ((resource.data.uid == request.auth.uid || profileId == request.auth.uid) &&
                       presenceOnlyUpdate()) ||
                      isAdmin()
                    )) || isDevMode();

      allow delete: if isAdmin() || isDevMode();
    }

    // ================== PROVIDERS ==================
    match /providers/{providerId} {
      function hasValidProviderFields() {
        return request.resource.data.keys().hasAll(['uid','type','fullName']) &&
               request.resource.data.uid is string &&
               request.resource.data.type in ['lawyer','expat'] &&
               request.resource.data.fullName is string;
      }

      allow read: if isPublicProfile() || isDocOwner() || isAdmin() || isDevMode();

      allow create: if ((creatingOwnDoc() && isProviderRole() && hasValidProviderFields())
                    || isAdmin()) || isDevMode();

      allow update: if isAdmin()
                    || (
                         isDocOwner() && isNotBanned() && hasValidProviderFields() && (
                           presenceOnlyUpdate() ||
                           onlyPhotoFieldsChanged() ||
                           hasNoSensitiveChanges()
                         )
                       ) || isDevMode();

      allow delete: if isAdmin() || isDevMode();
    }

    // ========= CALLS =========
    match /calls/{callId} {
      allow read: if (isAuthenticated() &&
                    (request.auth.uid == resource.data.clientId ||
                     request.auth.uid == resource.data.providerId) ||
                  isAdmin()) || isDevMode();

      allow create: if (isAuthenticated() && isNotBanned() &&
                     request.resource.data.clientId == request.auth.uid &&
                     request.resource.data.keys().hasAll(['clientId','providerId','serviceType'])) || isDevMode();

      allow update: if ((isAuthenticated() && isNotBanned() &&
                        (request.auth.uid == resource.data.clientId ||
                         request.auth.uid == resource.data.providerId)) ||
                     isAdmin()) || isDevMode();

      allow delete: if isAdmin() || isDevMode();
    }

    // ============ PAYMENTS ============
    match /payments/{paymentId} {
      function hasValidPaymentFields() {
        return request.resource.data.keys().hasAll(['clientId','providerId','amount','status']) &&
               request.resource.data.amount is number &&
               request.resource.data.amount > 0 &&
               request.resource.data.status in ['pending','authorized','captured','failed','refunded','canceled'];
      }

      allow read: if (isAuthenticated() &&
                    (request.auth.uid == resource.data.clientId ||
                     request.auth.uid == resource.data.providerId) ||
                  isAdmin()) || isDevMode();

      allow create: if (isAuthenticated() && isNotBanned() &&
                     request.resource.data.clientId == request.auth.uid &&
                     hasValidPaymentFields()) || isDevMode();

      allow update: if (isAdmin() && hasValidPaymentFields()) || isDevMode();
      allow delete: if isAdmin() || isDevMode();
    }

    // ========== REVIEWS ==========
    match /reviews/{reviewId} {
      function hasValidReviewFields() {
        return request.resource.data.keys().hasAll(['clientId','providerId','rating','comment']) &&
               request.resource.data.rating is number &&
               request.resource.data.rating >= 1 && request.resource.data.rating <= 5 &&
               request.resource.data.comment is string && request.resource.data.comment.size() > 0;
      }

      allow read: if resource.data.isPublic == true ||
                   (isAuthenticated() &&
                    (request.auth.uid == resource.data.clientId ||
                     request.auth.uid == resource.data.providerId)) ||
                   isAdmin() || isDevMode();

      allow create: if (isAuthenticated() && isNotBanned() &&
                     request.resource.data.clientId == request.auth.uid &&
                     hasValidReviewFields()) || isDevMode();

      allow update: if ((isAuthenticated() && request.auth.uid == resource.data.clientId &&
                        hasValidReviewFields() &&
                        !request.resource.data.diff(resource.data).affectedKeys()
                          .hasAny(['clientId','providerId','isPublic'])) ||
                        isAdmin()) || isDevMode();

      allow delete: if ((isAuthenticated() && request.auth.uid == resource.data.clientId) || isAdmin()) || isDevMode();
    }

    // ============ DOCUMENTS ============
    match /documents/{documentId} {
      allow read: if ((isAuthenticated() && request.auth.uid == resource.data.userId) || isAdmin()) || isDevMode();
      allow create: if (isAuthenticated() &&
                     request.resource.data.userId == request.auth.uid &&
                     request.resource.data.keys().hasAll(['userId','type','filename'])) || isDevMode();
      allow update: if isAdmin() || isDevMode();
      allow delete: if ((isAuthenticated() && request.auth.uid == resource.data.userId) || isAdmin()) || isDevMode();
    }

    // =============== NOTIFICATIONS ===============
    match /notifications/{notificationId} {
      allow read: if ((isAuthenticated() && request.auth.uid == resource.data.userId) || isAdmin()) || isDevMode();
      allow create: if isAdmin() || isDevMode();
      allow update: if ((isAuthenticated() && request.auth.uid == resource.data.userId &&
                        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isRead','readAt'])) ||
                       isAdmin()) || isDevMode();
      allow delete: if ((isAuthenticated() && request.auth.uid == resource.data.userId) || isAdmin()) || isDevMode();
    }

    // ================= CALL_SESSIONS =================
    match /call_sessions/{sessionId} {
      allow read: if ((isAuthenticated() &&
                    (request.auth.uid == resource.data.clientId ||
                     request.auth.uid == resource.data.providerId) ||
                  isAdmin())) || isDevMode();

      allow create: if (isAuthenticated() && isNotBanned() &&
                     request.resource.data.clientId == request.auth.uid) || isDevMode();

      allow update: if ((isAuthenticated() && isNotBanned() &&
                        (request.auth.uid == resource.data.clientId ||
                         request.auth.uid == resource.data.providerId)) ||
                     isAdmin()) || isDevMode();

      allow delete: if isAdmin() || isDevMode();
    }

    // ================== INVOICE_RECORDS ==================
    match /invoice_records/{invoiceId} {
      allow read: if ((isAuthenticated() &&
                    (request.auth.uid == resource.data.clientId ||
                     request.auth.uid == resource.data.providerId) ||
                  isAdmin())) || isDevMode();

      allow create: if (isAuthenticated() &&
                      (request.auth.uid == request.resource.data.clientId || isAdmin())) || isDevMode();

      allow update: if isAdmin() || isDevMode();
      allow delete: if isAdmin() || isDevMode();
    }

    // =================== NOTIFICATION_LOGS ===================
    match /notification_logs/{logId} {
      allow read: if ((isAuthenticated() &&
                    (request.auth.uid == resource.data.recipientId || isAdmin()))) || isDevMode();
      allow create: if (isAuthenticated() && isNotBanned()) || isDevMode();
      allow update: if isAdmin() || isDevMode();
      allow delete: if isAdmin() || isDevMode();
    }

    // ======================= Collections Admin =======================
    match /logs/{logId} {
      allow create: if true;
      allow read, update, delete: if isAdmin() || isDevMode();
    }
    match /analytics/{analyticsId} { allow read, write: if isAdmin() || isDevMode(); }
    match /app_settings/{settingId} { allow read, write: if isAdmin() || isDevMode(); }
    match /admin_settings/{settingId} { allow read, write: if isAdmin() || isDevMode(); }
    match /backups/{backupId} { allow read, write: if isAdmin() || isDevMode(); }

    match /contact_messages/{messageId} {
      allow read: if isAdmin() || isDevMode();
      allow create: if true;
      allow update, delete: if isAdmin() || isDevMode();
    }

    match /legal_documents/{docId} {
      allow read: if true;
      allow write: if isAdmin() || isDevMode();
    }

    match /coupons/{couponId} {
      allow read: if resource.data.active == true || isAdmin() || isDevMode();
      allow write: if isAdmin() || isDevMode();
    }

    match /coupon_usages/{usageId} {
      allow read: if ((isAuthenticated() && request.auth.uid == resource.data.userId) || isAdmin()) || isDevMode();
      allow create: if (isAuthenticated() && request.resource.data.userId == request.auth.uid) || isDevMode();
      allow update, delete: if isAdmin() || isDevMode();
    }

    match /{document=**} {
      allow read, write: if false || isDevMode();
    }
  }
}

service cloud.firestore {
  match /databases/{database}/documents {

    // Lecture ouverte (ou restreins si tu veux)
    match /admin_config/{docId} {
      allow read: if true;

      // Ecriture réservée aux admins (custom claim)
      allow write: if request.auth != null && request.auth.token.admin == true;
    }

    // …tes autres règles
  }
}